angular.module("lds.io.storage",[]).service("LdsApiStorage",["$window","$q",function LdsApiStorage($window,$q){var prefix="io.lds.";var LdsIoStorage={init:function(pre){if(pre){prefix=pre}},get:function(key){var val;try{val=JSON.parse(localStorage.getItem(prefix+key)||null)}catch(e){console.error("couldn't parse "+prefix+key,localStorage.getItem(prefix+key));localStorage.removeItem(prefix+key);val=null}if("undefined"===val||"null"===val){console.warn("got undefined for "+prefix+key);val=null}return val&&$q.when(val)||$q.reject()},set:function(key,val){try{localStorage.setItem(prefix+key,JSON.stringify(val));return $q.when()}catch(e){console.error("couldn't stringify "+prefix+key,val);return $q.reject(e)}},remove:function(key){localStorage.removeItem(prefix+key);return $q.when()},clear:function(account){var re;var keys=[];var i;var key;re=new RegExp("^"+prefix.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+(account||""));for(i=0;i<localStorage.length;i+=1){key=localStorage.key(i);if(re.test(key)){keys.push(key)}}keys.forEach(function(key){localStorage.removeItem(key)});return $q.when()}};$window.LdsIo=$window.LdsIo||{};$window.LdsIo.storage=LdsIoStorage;return LdsIoStorage}]);"use strict";angular.module("lds.io.config",["lds.io.storage"]).service("LdsApiConfig",["$window","LdsApiStorage",function LdsApiConfig($window,LdsApiStorage){var defaults={providerUri:"https://lds.io",appUri:$window.location.protocol+"//"+$window.location.host+$window.location.pathname,appId:null,apiPrefix:"/api/ldsio",logoutIframe:"/logout.html",refreshWait:15*60*60*1e3,uselessWait:Infinity,invokeLogin:function(){$window.alert("override `LdsApiConfig.invokeLogin` with a function that shows a login dialog,"+" calls LdsApiSession.login on click, and returns a promise in that chain."+" TODO document on website")}};var LdsIoConfig={init:function(opts){var me=this;opts=opts||{};return LdsApiStorage.get("providerUri").then(function(val){console.info("API set to "+val);console.log("set to custom provider with `LdsIo.storage.set('providerUri', 'https://example.com')`");console.log("or set to default with `LdsIo.storage.remove('providerUri')`");me.providerUri=val;me.developerMode=true},function(){}).then(function(){Object.keys(opts).forEach(function(key){if("appSecret"===key){$window.alert("[ERROR] appSecret must never be used in a client (browser, mobile, or desktop)");return}me[key]=opts[key]});Object.keys(defaults).forEach(function(key){if("undefined"===typeof me[key]){me[key]=defaults[key]}});if(!me.appId){$window.alert("[ERROR] you did not supply `LdsApiConfig.appId`. Consider using 'TEST_ID_9e78b54c44a8746a5727c972'")}return me})}};$window.LdsIo=$window.LdsIo||{};$window.LdsIo.config=LdsIoConfig;return LdsIoConfig}]);"use strict";angular.module("lds.io.cache",["lds.io.storage"]).service("LdsApiCache",["$window","$q","LdsApiStorage",function LdsApiCache($window,$q,LdsApiStorage){var LdsIoCache;var caches;var refreshIn=15*60*1e3;var uselessIn=Infinity;function init(){return LdsApiStorage.get("caches").then(function(result){caches=result},function(){caches={}})}function apiCall(id,url,fetch,opts){var refreshWait=refreshIn;var uselessWait=uselessIn;var fresh;var usable;var now;var promise;function fin(value){promise=null;caches[id]=Date.now();return LdsApiStorage.set(id,value).then(function(){return LdsApiStorage.set("caches",caches).then(function(){return{updated:caches[id],value:value,stale:false}})})}if(caches[id]&&!(opts&&opts.expire)){now=Date.now();usable=now-caches[id]<uselessWait;fresh=now-caches[id]<refreshWait;if(!fresh){promise=fetch().then(fin)}}return LdsApiStorage.get(id).then(function(result){if(usable){return $q.when({updated:caches[id],value:result,stale:!fresh})}else{return(promise||fetch()).then(fin)}},function(){return(promise||fetch()).then(fin)})}function destroy(){caches={};return LdsApiStorage.clear()}LdsIoCache={init:init,read:apiCall,destroy:destroy};$window.LdsIo=$window.LdsIo||{};$window.LdsIo.cache=LdsIoCache;return LdsIoCache}]);"use strict";angular.module("lds.io.session",["lds.io.cache","lds.io.storage","lds.io.config"]).service("LdsApiSession",["$window","$timeout","$q","$http","LdsApiConfig","LdsApiStorage","LdsApiCache",function LdsApiSession($window,$timeout,$q,$http,LdsApiConfig,LdsApiStorage,LdsApiCache){var shared={session:{}};var logins={};function save(session){localStorage.setItem("io.lds.session",JSON.stringify(session));return $q.when(session)}function restore(){var storedSession;if(shared.session.token){return $q.when(shared.session)}storedSession=JSON.parse(localStorage.getItem("io.lds.session")||null)||{};if(storedSession.token){shared.session=storedSession;return $q.when(shared.session)}else{return $q.reject(new Error("No Session"))}}function destroy(){if(!shared.session.token){return $q.when(shared.session)}shared.session={};localStorage.removeItem("io.lds.session");return LdsApiCache.destroy().then(function(session){return session})}function testToken(session){return $http.get(LdsApiConfig.providerUri+LdsApiConfig.apiPrefix+"/accounts",{headers:{Authorization:"Bearer "+session.token}}).then(function(resp){var accounts=resp.data&&resp.data.accounts||resp.data;var id;if(!Array.isArray(accounts)||accounts.error){console.error("ERR acc",accounts);return $q.reject(new Error("could not verify session"))}if(1!==accounts.length){console.error("SCF acc.length",accounts.length);return $q.reject(new Error("[SANITY CHECK FAILED] number of accounts: '"+accounts.length+"'"))}id=accounts[0].app_scoped_id||accounts[0].id;if(!id){console.error("SCF acc[0].id",accounts);return $q.reject(new Error("[SANITY CHECK FAILED] could not get account id"))}session.id=id;session.ts=Date.now();return session})}function logout(){var url=LdsApiConfig.providerUri+LdsApiConfig.logoutIframe;var $iframe=$('<iframe src="'+url+'" width="1px" height="1px" style="opacity: 0.01;" frameborder="0"></iframe>');$("body").append($iframe);return $timeout(function(){$iframe.remove()},500).then(function(){destroy()})}function backgroundLogin(){return restore().then(function(session){return testToken(session)},function(){silentLogin();return})}function parseLogin(name,url){var tokenMatch=url.match(/(^|\#|\?|\&)access_token=([^\&]+)(\&|$)/);var idMatch=url.match(/(^|\#|\?|\&)id=([^\&]+)(\&|$)/);var token;var id;if(tokenMatch){token=tokenMatch[2]}if(idMatch){id=idMatch[2]}return{token:token,id:id}}$window.completeLogin=function(name,url){var params=parseLogin(name,url);var d=logins[params.id];if(!params.id){throw new Error("could not parse id from login")}if(!params.token){return $q.reject(new Error("didn't get token"))}shared.session.token=params.token;return testToken(shared.session).then(save).then(d.resolve,d.reject)};function createLogin(d,oauthscope){var requestedScope=oauthscope||["me"];var id=Math.random().toString().replace(/0\./,"");logins[id]=d;var url=LdsApiConfig.providerUri+"/api/oauth3/authorization_dialog"+"?response_type=token"+"&client_id="+LdsApiConfig.appId+"&redirect_uri="+encodeURIComponent(LdsApiConfig.appUri+"/bower_components/oauth3/oauth3.html"+"?id="+encodeURIComponent(id)+"&provider_uri="+encodeURIComponent("ldsconnect.org")+"&shim="+encodeURIComponent("/callbacks/ldsconnect.org"))+"&scope="+encodeURIComponent(requestedScope.join(" "))+"&state="+Math.random().toString().replace(/^0./,"");return url}function silentLogin(oauthscope){if(silentLogin._inProgress){return silentLogin._inProgress}var d=$q.defer();var url=createLogin(d,oauthscope);var $iframe=$('<iframe src="'+url+'" width="1px" height="1px" style="opacity: 0.01;" frameborder="0"></iframe>');function removeIframe(data){silentLogin._inProgress=null;$iframe.remove();return data}function removeIframeErr(err){silentLogin._inProgress=null;$iframe.remove();return $q.reject(err)}$("body").append($iframe);silentLogin._inProgress=d.promise.then(removeIframe,removeIframeErr);return silentLogin._inProgress}function login(oauthscope,opts){function forceLogin(){var d=$q.defer();var url=createLogin(d,oauthscope);$window.open(url,"ldsioLogin","height=720,width=620");return d.promise}return checkSession().then(function(session){if(!session.id||opts&&opts.force){return forceLogin()}return session},forceLogin)}function requireSession(){return restore().then(function(session){return session},function(){return LdsApiConfig.invokeLogin()})}function checkSession(){return restore()}function onLogin(_scope,fn){_scope.__stsessionshared__=shared;_scope.$watch("__stsessionshared__.session",function(newValue,oldValue){if(!oldValue.id&&newValue.id){fn(shared.session)}},true)}function onLogout(_scope,fn){_scope.__stsessionshared__=shared;_scope.$watch("__stsessionshared__.session",function(newValue,oldValue){if(oldValue.token&&!newValue.token){fn(null)}},true)}return{restore:restore,destroy:destroy,login:login,logout:logout,onLogin:onLogin,onLogout:onLogout,checkSession:checkSession,requireSession:requireSession,backgroundLogin:backgroundLogin}}]);"use strict";angular.module("lds.io.api",["lds.io.cache","lds.io.config"]).service("LdsApiRequest",["$window","$timeout","$q","$http","LdsApiConfig","LdsApiCache",function LdsApiRequest($window,$timeout,$q,$http,LdsApiConfig,LdsApiCache){var LdsIoApi;var promises={};function realGet(session,id,url){if(promises[id]){return promises[id]}promises[id]=$http.get(url,{headers:{Authorization:"Bearer "+session.token}}).then(function(resp){delete promises[id];if(!resp.data){window.alert("[SANITY FAIL] '"+url+"' returned nothing (not even an error)");return}if(resp.data.error){console.error("[ERROR]",url);console.error(resp.data);window.alert("[DEVELOPER ERROR] '"+url+"' returned an error (is the url correct? did you check login first?)");return}return resp.data},function(err){delete promises[id];return $q.reject(err)});return promises[id]}function promiseApiCall(session,id,url,opts){opts=opts||{};return LdsApiCache.read(id,url,function(){var d=$q.defer();var token=$timeout(function(){if(opts.tried){d.reject(new Error("timed out (twice) when attempting to get data"));return}opts.tried=true;return promiseApiCall(session,id,url,opts).then(d.resolve,d.reject)},opts.tried&&16e3||8e3);realGet(session,id,url).then(function(data){$timeout.cancel(token);return d.resolve(data)},function(err){$timeout.cancel(token);return d.reject(err)});return d.promise},opts).then(function(data){return data.value})}LdsIoApi={init:function(){},profile:function(session,opts){var id=session.id+".me";var url=LdsApiConfig.providerUri+LdsApiConfig.apiPrefix+"/"+session.id+"/me";return promiseApiCall(session,id,url,opts)},stake:function(session,stakeId,opts){var id=session.id+"stake."+stakeId;var url=LdsApiConfig.providerUri+LdsApiConfig.apiPrefix+"/"+session.id+"/stakes/"+stakeId;return promiseApiCall(session,id,url,opts)},stakePhotos:function(session,stakeId,opts){var id=session.id+"stake."+stakeId;var url=LdsApiConfig.providerUri+LdsApiConfig.apiPrefix+"/"+session.id+"/stakes/"+stakeId+"/photos";return promiseApiCall(session,id,url,opts)},ward:function(session,stakeId,wardId,opts){var id=session.id+"stake."+stakeId+".ward."+wardId;var url=LdsApiConfig.providerUri+LdsApiConfig.apiPrefix+"/"+session.id+"/stakes/"+stakeId+"/wards/"+wardId;return promiseApiCall(session,id,url,opts)},wardPhotos:function(session,stakeId,wardId,opts){var id=session.id+"stake."+stakeId+".ward."+wardId+".photos";var url=LdsApiConfig.providerUri+LdsApiConfig.apiPrefix+"/"+session.id+"/stakes/"+stakeId+"/wards/"+wardId+"/photos";return promiseApiCall(session,id,url,opts)},photoUrl:function(session,photo,size,type){return LdsApiConfig.providerUri+LdsApiConfig.apiPrefix+"/"+session.id+"/photos/"+(type||photo.type)+"/"+(photo.app_scoped_id||photo.id)+"/"+(photo.updated_at||"bad-updated-at")+"/"+(size||"medium")+"/"+(photo.app_scoped_id||photo.id)+".jpg"+"?access_token="+session.token},guessGender:function(m){var men=["highPriest","high_priest","highpriest","elder","priest","teacher","deacon"];var women=["reliefSociety","relief_society","reliefsociety","laurel","miamaid","beehive"];if(men.some(function(thing){return m[thing]})){return"male"}if(women.some(function(thing){return m[thing]})){return"female"}}};$window.LdsIo=$window.LdsIo||{};$window.LdsIo.api=LdsIoApi;return LdsIoApi}]);"use strict";angular.module("lds.io",["lds.io.api","lds.io.session","lds.io.cache","lds.io.storage"]).service("LdsApi",["$window","LdsApiConfig","LdsApiCache",function($window,LdsApiConfig,LdsApiCache){var LdsIo={init:function(opts){if("object"!==typeof opts){$window.alert("[ERROR] you did not supply an options object to LdsApiConfig.init()")}return LdsApiConfig.init(opts).then(function(LdsApiConfig){return LdsApiCache.init().then(function(){return LdsApiConfig})})}};$window.LdsIo=$window.LdsIo||{};$window.LdsIo.init=LdsIo.init;return LdsIo}]);